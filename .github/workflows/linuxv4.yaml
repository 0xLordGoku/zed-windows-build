name: Cloud Phone CI with Screen Access
on: [workflow_dispatch]

jobs:
  cloud-phone:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download APKs
      run: |
        mkdir -p apks
        
        # Download Clash of Clans APK (using APKPure mirror)
        echo "Downloading Clash of Clans..."
        wget -q "https://d.apkpure.com/b/APK/com.supercell.clashofclans?version=latest" -O apks/clash-of-clans.apk || \
        curl -L "https://apkcombo.com/clash-of-clans/com.supercell.clashofclans/download/apk" -o apks/clash-of-clans.apk || \
        echo "Failed to download Clash of Clans"
        
        # Add more apps here (examples):
        # wget -q "https://f-droid.org/repo/org.fdroid.fdroid_1016053.apk" -O apks/fdroid.apk
        # wget -q "https://github.com/you/your-app/releases/download/v1.0/app.apk" -O apks/your-app.apk
        
        ls -lh apks/
      
    # Enable KVM for hardware acceleration
    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        
    - name: Download ngrok
      run: |
        curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
    - name: Auth ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Run Android Emulator with Screen Access
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30                    # Android 11 (better performance than 14)
        target: google_apis              # Includes Google Play Services
        arch: x86_64
        profile: pixel_3a                # Lighter device profile
        ram-size: 3072M                  # 3GB RAM (sweet spot)
        heap-size: 512M                  # Reduced heap
        disk-size: 6144M                 # 6GB disk
        cores: 4                         # Use 4 CPU cores
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -skin 720x1280 -qemu -smp 4
        disable-animations: true
        disable-spellchecker: true
        disable-linux-hw-accel: false    # Enable KVM hardware acceleration
        emulator-boot-timeout: 600       # 10 minutes
        script: |
          echo "============================================"
          echo "üöÄ Setting up Android Emulator..."
          echo "============================================"
          
          adb devices
          
          # Disable animations for better performance
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0
          
          # Install pre-downloaded APKs
          echo ""
          echo "üì¶ Installing applications..."
          
          if [ -d "apks" ] && [ "$(ls -A apks/*.apk 2>/dev/null)" ]; then
            for apk in apks/*.apk; do
              echo "Installing $(basename $apk)..."
              adb install -r "$apk" && echo "‚úÖ Installed $(basename $apk)" || echo "‚ùå Failed to install $(basename $apk)"
            done
          else
            echo "No APKs found to install"
          fi
          
          echo ""
          echo "Installed apps:"
          adb shell pm list packages -3
          
          # Enable TCP/IP mode on port 5555
          echo ""
          echo "Enabling ADB over TCP/IP..."
          adb tcpip 5555
          sleep 3
          
          # Download and setup scrcpy server
          echo "Setting up scrcpy server for screen mirroring..."
          wget -q https://github.com/Genymobile/scrcpy/releases/download/v2.4/scrcpy-server-v2.4 -O scrcpy-server.jar
          adb push scrcpy-server.jar /data/local/tmp/scrcpy-server.jar
          
          # Start only ONE ngrok tunnel for ADB (port 5555)
          echo "Starting ngrok tunnel..."
          ./ngrok tcp 5555 --log=stdout > ngrok.log &
          NGROK_PID=$!
          
          sleep 8
          
          # Get ngrok URL
          NGROK_DATA=$(curl -s http://localhost:4040/api/tunnels)
          ADB_URL=$(echo "$NGROK_DATA" | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
          
          echo ""
          echo "============================================"
          echo "üéâ EMULATOR IS READY!"
          echo "============================================"
          echo ""
          echo "üì± Step 1: Connect via ADB"
          echo "  adb connect $ADB_URL"
          echo ""
          echo "üñ•Ô∏è  Step 2: Run scrcpy to see the screen"
          echo ""
          echo "üöÄ FASTEST (Recommended - lower quality, faster response):"
          echo "  scrcpy -s $ADB_URL --max-size 800 --max-fps 15 --video-codec h264 --video-encoder MediaCodec --no-audio"
          echo ""
          echo "‚ö° BALANCED (Good quality, decent speed):"
          echo "  scrcpy -s $ADB_URL --max-size 1024 --max-fps 30 --video-bit-rate 2M --no-audio"
          echo ""
          echo "üé® HIGH QUALITY (Slower but better visuals):"
          echo "  scrcpy -s $ADB_URL --max-size 1920 --max-fps 60 --video-bit-rate 8M"
          echo ""
          echo "üì∏ Take screenshots:"
          echo "  adb -s $ADB_URL shell screencap -p /sdcard/screen.png"
          echo "  adb -s $ADB_URL pull /sdcard/screen.png"
          echo ""
          echo "============================================"
          echo "Ngrok Dashboard: http://localhost:4040"
          echo "============================================"
          echo ""
          echo "‚è∞ Connection will stay alive for 6 hours"
          echo "   Started at: $(date)"
          echo ""
          echo "üí° Tips:"
          echo "   - If connection drops, just reconnect: adb connect $ADB_URL"
          echo "   - ADB keepalive is running in background"
          echo "   - Check ngrok dashboard if issues persist"
          echo ""
          
          # Keep the workflow alive for 6 hours
          sleep 21600
          
          echo "Shutting down at: $(date)"
          kill $NGROK_PID || true
          kill $KEEPALIVE_PID || true
