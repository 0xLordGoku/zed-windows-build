name: Android 11
on: [workflow_dispatch]

jobs:
  cloud-phone:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download APKs
      run: |
        mkdir -p apks
        
        echo "Downloading Clash of Clans..."
        
        # -------------------------------------------------------
        # FIX: Using the direct signed link (quoted to prevent errors)
        # Note: This link expires in ~4 hours. For a permanent fix, 
        # upload this APK to your GitHub Releases and link it here.
        # -------------------------------------------------------
        wget -O apks/clash-of-clans.apk 'https://apks.39b7cb94d40914bac590886981b0ed6e.r2.cloudflarestorage.com/com.supercell.clashofclans/18.0.2/180000003.950a41404354260cc91207fd381da4ddeb31b6a5.apk?response-content-disposition=attachment%3B%20filename%3D%22Clash%20of%20Clans_18.0.2_apkcombo.com.apk%22&response-content-type=application%2Fvnd.android.package-archive&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20251123T190414Z&X-Amz-SignedHeaders=host&X-Amz-Expires=14400&X-Amz-Credential=3cb727b4cd4780c410b780ac7caa4da3%2F20251123%2Fauto%2Fs3%2Faws4_request&X-Amz-Signature=63ec76ad14ef55ceb47dd8ed3645cabed7fad907991e667b55d93854f1d85690'
        
        # Verify file size (should be ~300MB+, not 10KB)
        ls -lh apks/
      
    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        
    - name: Download ngrok
      run: |
        curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
    - name: Auth ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Create Logic Script
      run: |
        cat << 'EOF' > emulator_script.sh
        #!/bin/bash
        set -e
        
        echo "============================================"
        echo "ðŸš€ Setting up Android Emulator..."
        echo "============================================"
        
        adb devices
        
        # Disable animations for better performance
        adb shell settings put global window_animation_scale 0
        adb shell settings put global transition_animation_scale 0
        adb shell settings put global animator_duration_scale 0
        
        echo ""
        echo "ðŸ“¦ Installing applications..."
        
        # Install all APKs found in the folder
        if compgen -G "apks/*.apk" > /dev/null; then
          for apk in apks/*.apk; do
            echo "Installing $(basename "$apk")..."
            adb install -r "$apk" && echo "âœ… Installed" || echo "âŒ Failed"
          done
          echo ""
          echo "Installed apps:"
          adb shell pm list packages -3
        else
          echo "No APKs found to install."
        fi
        
        # Enable TCP/IP mode on port 5555
        echo ""
        echo "Enabling ADB over TCP/IP..."
        adb tcpip 5555
        sleep 3
        
        # Download and setup scrcpy server
        echo "Setting up scrcpy server for screen mirroring..."
        wget -q https://github.com/Genymobile/scrcpy/releases/download/v2.4/scrcpy-server-v2.4 -O scrcpy-server.jar
        adb push scrcpy-server.jar /data/local/tmp/scrcpy-server.jar
        
        # Start ngrok tunnel
        echo "Starting ngrok tunnel..."
        ./ngrok tcp 5555 --log=stdout > ngrok.log &
        NGROK_PID=$!
        
        sleep 8
        
        # Get ngrok URL
        NGROK_DATA=$(curl -s http://localhost:4040/api/tunnels)
        ADB_URL=$(echo "$NGROK_DATA" | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
        
        echo ""
        echo "============================================"
        echo "ðŸŽ‰ EMULATOR IS READY!"
        echo "============================================"
        echo ""
        echo "ðŸ“± Step 1: Connect via ADB"
        echo "  adb connect $ADB_URL"
        echo ""
        echo "ðŸ–¥ï¸  Step 2: Run scrcpy"
        echo "  scrcpy -s $ADB_URL --max-size 1024 --max-fps 30 --video-bit-rate 2M --no-audio"
        echo ""
        echo "â° Connection will stay alive for 6 hours"
        echo ""
        
        # Keep the script running
        sleep 21600
        
        echo "Shutting down..."
        kill $NGROK_PID 2>/dev/null || true
        EOF
        
        chmod +x emulator_script.sh

    - name: Run Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        profile: pixel_3a
        ram-size: 3072M
        heap-size: 512M
        disk-size: 6144M
        cores: 4
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -skin 720x1280 -qemu -smp 4
        disable-animations: true
        disable-spellchecker: true
        disable-linux-hw-accel: false
        emulator-boot-timeout: 600
        script: ./emulator_script.sh
