name: Android 14
on: [workflow_dispatch]

jobs:
  cloud-phone:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Enable KVM for hardware acceleration
    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        
    - name: Download ngrok
      run: |
        curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
    - name: Auth ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Run Android Emulator with Screen Access
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34                    # Android 14 (latest stable)
        target: google_apis              # Includes Google Play Services
        arch: x86_64
        profile: pixel_6                 # Modern device profile
        ram-size: 4096M                  # 4GB RAM (increased from 2GB)
        heap-size: 1024M                 # 1GB heap (increased from 512MB)
        disk-size: 8192M                 # 8GB disk space
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -skin 1080x2400
        disable-animations: true
        disable-spellchecker: true
        emulator-boot-timeout: 900       # 15 minutes (newer Android takes longer)
        script: |
          echo "============================================"
          echo "üöÄ Setting up Android Emulator..."
          echo "============================================"
          
          adb devices
          
          # Disable animations for better performance
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0
          
          # Enable TCP/IP mode on port 5555
          echo "Enabling ADB over TCP/IP..."
          adb tcpip 5555
          sleep 3
          
          # Download and setup scrcpy server
          echo "Setting up scrcpy server for screen mirroring..."
          wget -q https://github.com/Genymobile/scrcpy/releases/download/v2.4/scrcpy-server-v2.4 -O scrcpy-server.jar
          adb push scrcpy-server.jar /data/local/tmp/scrcpy-server.jar
          
          # Start only ONE ngrok tunnel for ADB (port 5555)
          echo "Starting ngrok tunnel..."
          ./ngrok tcp 5555 --log=stdout > ngrok.log &
          NGROK_PID=$!
          
          sleep 8
          
          # Get ngrok URL
          NGROK_DATA=$(curl -s http://localhost:4040/api/tunnels)
          ADB_URL=$(echo "$NGROK_DATA" | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
          
          echo ""
          echo "============================================"
          echo "üéâ EMULATOR IS READY!"
          echo "============================================"
          echo ""
          echo "üì± Step 1: Connect via ADB"
          echo "  adb connect $ADB_URL"
          echo ""
          echo "üñ•Ô∏è  Step 2: Run scrcpy to see the screen"
          echo "  scrcpy -s $ADB_URL"
          echo ""
          echo "Alternative commands:"
          echo "  scrcpy -s $ADB_URL --no-audio"
          echo "  scrcpy -s $ADB_URL --max-size 1024"
          echo ""
          echo "üì∏ Take screenshots:"
          echo "  adb -s $ADB_URL shell screencap -p /sdcard/screen.png"
          echo "  adb -s $ADB_URL pull /sdcard/screen.png"
          echo ""
          echo "============================================"
          echo "Ngrok Dashboard: http://localhost:4040"
          echo "============================================"
          echo ""
          echo "‚è∞ Connection will stay alive for 6 hours"
          echo "   Started at: $(date)"
          echo ""
          
          # Keep the workflow alive for 6 hours
          sleep 21600
          
          echo "Shutting down at: $(date)"
          kill $NGROK_PID || true
