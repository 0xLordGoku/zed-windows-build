name: Cloud Phone CI
on: [workflow_dispatch] # Manual trigger only

jobs:
  cloud-phone:
    runs-on: ubuntu-latest # MUST be Ubuntu, not Windows
    steps:
    # 1. Setup Ngrok (Your tunnel)
    - name: Download ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xvzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
    - name: Auth ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    # 2. Install & Run Redroid (The Phone)
    # Note: Redroid often fails on standard GH runners due to missing kernel modules.
    # If this fails, we use the standard emulator in step 3.
    - name: Try Starting Redroid
      continue-on-error: true
      run: |
        # Attempt to load modules if available (often fails on shared runners)
        sudo modprobe binder_linux devices=binder,hwbinder,vndbinder || true
        
        # Run the container
        docker run -d -p 5555:5555 \
          --privileged \
          redroid/redroid:11.0.0-latest

    # 3. Alternative: Standard Android Emulator (Slower but Guaranteed to Work)
    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Run Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: default
        arch: x86_64
        profile: Nexus 6
        script: |
          # This script runs INSIDE the emulator step
          echo "Emulator is running!"
          
          # Start ADB server
          adb devices
          
          # Start the tunnel for ADB (Port 5555)
          # You will connect to this from your PC using: adb connect tcp://0.tcp.ngrok.io:12345
          ../ngrok tcp 5555 &
          
          # Keep it alive for 6 hours (GitHub limit)
          sleep 21600
