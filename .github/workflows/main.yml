name: CI
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Enable Long Path Support
      run: |
        reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
    
    # Setup RDP access FIRST
    - name: Download ngrok
      run: Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
    - name: Extract ngrok
      run: Expand-Archive ngrok.zip
    - name: Auth ngrok
      run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
    - name: Enable TS
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
    - name: Allow RDP Through Firewall
      run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
    - name: Require NLA
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
    - name: Reset runneradmin Password
      run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
    
    # Start ngrok tunnel in background
    - name: Create Tunnel and Run Build
      run: |
        # Start ngrok tunnel in background
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp", "3389" -WindowStyle Hidden
        Start-Sleep -Seconds 10
        Write-Host "RDP tunnel should be available now!"
        
        # Create log file
        $logFile = "build-log.txt"
        
        # Start the build process in background with full logging
        $buildJob = Start-Job -ScriptBlock {
          param($workDir, $logFile)
          Set-Location $workDir
          
          # Function to log with timestamp
          function Write-Log {
            param([string]$message)
            $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            $logMessage = "[$timestamp] $message"
            Write-Host $logMessage
            Add-Content -Path $logFile -Value $logMessage
          }
          
          try {
            Write-Log "=== Starting Zed Build Process ==="
            Write-Log "Working directory: $(Get-Location)"
            
            # Configure git for long paths FIRST
            Write-Log "Configuring git for long paths..."
            git config --global core.longpaths true
            Write-Log "Git longpaths configured successfully"
            
            # Install CMake
            Write-Log "Installing CMake..."
            $cmakeInstall = choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y 2>&1
            Write-Log "CMake installation completed"
            
            # Install Rustup
            Write-Log "Installing Rustup..."
            $rustupInstall = choco install rustup.install -y 2>&1
            Write-Log "Rustup installation completed"
            
            # Refresh environment variables manually and create new process
            Write-Log "Refreshing environment and starting new PowerShell session..."
            
            # Create a new PowerShell process with refreshed environment
            $newPSJob = Start-Job -ScriptBlock {
              param($workDir, $logFile)
              Set-Location $workDir
              
              function Write-Log {
                param([string]$message)
                $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                $logMessage = "[$timestamp] $message"
                Write-Host $logMessage
                Add-Content -Path $logFile -Value $logMessage
              }
              
              try {
                Write-Log "=== New PowerShell session started ==="
                
                # Verify installations in new session
                Write-Log "Verifying installations..."
                
                # Check CMake
                try {
                  $cmakeVersion = cmake --version 2>&1
                  Write-Log "CMake version: $cmakeVersion"
                } catch {
                  Write-Log "CMake not found in PATH, trying to locate..."
                  $cmakePath = Get-Command cmake -ErrorAction SilentlyContinue
                  if ($cmakePath) {
                    Write-Log "CMake found at: $($cmakePath.Source)"
                  } else {
                    Write-Log "CMake not found, adding to PATH..."
                    $env:PATH += ";C:\Program Files\CMake\bin"
                  }
                }
                
                # Check Rust
                try {
                  $rustupVersion = rustup --version 2>&1
                  $cargoVersion = cargo --version 2>&1
                  $rustcVersion = rustc --version 2>&1
                  
                  Write-Log "Rustup version: $rustupVersion"
                  Write-Log "Cargo version: $cargoVersion"
                  Write-Log "Rustc version: $rustcVersion"
                } catch {
                  Write-Log "Rust tools not found in PATH, adding manually..."
                  $env:PATH += ";$env:USERPROFILE\.cargo\bin"
                  
                  # Try again
                  $rustupVersion = & "$env:USERPROFILE\.cargo\bin\rustup.exe" --version 2>&1
                  $cargoVersion = & "$env:USERPROFILE\.cargo\bin\cargo.exe" --version 2>&1
                  $rustcVersion = & "$env:USERPROFILE\.cargo\bin\rustc.exe" --version 2>&1
                  
                  Write-Log "Rustup version: $rustupVersion"
                  Write-Log "Cargo version: $cargoVersion"
                  Write-Log "Rustc version: $rustcVersion"
                }
                
                # Initialize Rust toolchain
                Write-Log "Initializing Rust stable toolchain..."
                rustup default stable
                Write-Log "Rust toolchain initialized"
                
                # Clone Zed repository
                Write-Log "Cloning Zed repository..."
                $cloneResult = git clone https://github.com/zed-industries/zed.git 2>&1
                Write-Log "Git clone completed"
                
                if (Test-Path "zed") {
                  Write-Log "Successfully cloned Zed repository"
                  Set-Location "zed"
                  Write-Log "Changed to zed directory: $(Get-Location)"
                  
                  Write-Log "=== Starting Cargo Run Process ==="
                  Write-Log "This may take 1-2 hours... Please be patient!"
                  Write-Log "Building and running Zed editor..."
                  
                  # Run cargo run --release
                  $cargoResult = cargo run --release 2>&1
                  Write-Log "Cargo run output: $cargoResult"
                  
                  if ($LASTEXITCODE -eq 0) {
                    Write-Log "=== BUILD AND RUN SUCCESSFUL ==="
                  } else {
                    Write-Log "=== BUILD/RUN FAILED with exit code: $LASTEXITCODE ==="
                  }
                } else {
                  Write-Log "ERROR: Failed to clone Zed repository"
                }
                
              } catch {
                Write-Log "ERROR: Exception in new session: $($_.Exception.Message)"
              }
              
              Write-Log "=== Build Process Completed ==="
            } -ArgumentList $workDir, $logFile
            
            # Wait for the new PowerShell job to complete
            Write-Log "Waiting for new PowerShell session to complete..."
            Wait-Job $newPSJob
            $newPSOutput = Receive-Job $newPSJob
            Write-Log "New PowerShell session output: $newPSOutput"
            
          } catch {
            Write-Log "ERROR: Exception occurred: $($_.Exception.Message)"
            Write-Log "Stack trace: $($_.Exception.StackTrace)"
          }
          
          Write-Log "=== All Build Processes Completed ==="
        } -ArgumentList (Get-Location), $logFile
        
        # Keep monitoring build status and maintain RDP tunnel with 1-second updates
        Write-Host "=== Build started in background ==="
        Write-Host "RDP tunnel will remain active throughout the process"
        Write-Host "You can connect via RDP to monitor progress in real-time"
        Write-Host "Log file: build-log.txt"
        
        $startTime = Get-Date
        while ($buildJob.State -eq "Running") {
          Start-Sleep -Seconds 1  # Update every second
          $elapsed = (Get-Date) - $startTime
          
          # Show recent log entries if log file exists
          if (Test-Path $logFile) {
            $recentLogs = Get-Content $logFile -Tail 5 -ErrorAction SilentlyContinue
            if ($recentLogs) {
              # Clear previous output and show current status
              Clear-Host
              Write-Host "Build running for: $($elapsed.ToString('hh\:mm\:ss')) | RDP tunnel active"
              Write-Host "Recent log entries:"
              $recentLogs | ForEach-Object { Write-Host "  $_" }
              Write-Host "`n--- Live log monitoring (updates every second) ---"
            }
          } else {
            Write-Host "Build running for: $($elapsed.ToString('hh\:mm\:ss')) | RDP tunnel active | Waiting for log file..."
          }
        }
        
        # Get final build results
        Write-Host "=== Build job completed ==="
        $buildOutput = Receive-Job -Job $buildJob -Wait
        Write-Host "Final build output:"
        Write-Host $buildOutput
        
        # Display final log summary
        if (Test-Path $logFile) {
          Write-Host "=== Final Log Summary ==="
          $logContent = Get-Content $logFile
          Write-Host "Total log lines: $($logContent.Count)"
          Write-Host "Last 20 log entries:"
          $logContent | Select-Object -Last 20 | ForEach-Object { Write-Host "  $_" }
        }
        
        # Keep RDP tunnel active indefinitely (or until GitHub Actions timeout)
        Write-Host "=== Build process finished ==="
        Write-Host "RDP tunnel will remain active until workflow timeout"
        Write-Host "You can connect to review build results, logs, and built files"
        Write-Host "Entering infinite loop to keep tunnel alive..."
        
        # Infinite loop to keep RDP active
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host "RDP tunnel still active... $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }
