name: Test Upload and Issue Creation
on: [push, workflow_dispatch]

permissions:
  contents: read
  issues: write

jobs:
  test-upload-and-issue:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create test file
      run: |
        cat <<-EOF > test-upload.txt
        Test File for Upload
        ====================
        Created: $(date)
        Repository: ${{ github.repository }}
        Commit: ${{ github.sha }}
        Workflow Run: ${{ github.run_id }}

        This is a test file to verify the upload functionality.
        EOF
        echo "Created test file:"
        cat test-upload.txt

    - name: Upload file and Set Status
      id: upload
      run: |
        # Use curl's silent flag (-s) to hide the progress meter.
        # Use grep to find the line containing "http" and awk to extract just the URL.
        # The exit code of the pipeline will be the exit code of the last command (awk).
        download_link=$(curl -s -T ./test-upload.txt bashupload.com | grep 'http' | awk '{print $2}')
        
        # Check if the extracted link looks like a valid URL.
        if [[ "$download_link" == http* ]]; then
          echo "Upload successful!"
          echo "Download Link: $download_link"
          echo "upload_status=success" >> $GITHUB_OUTPUT
          echo "download_link=$download_link" >> $GITHUB_OUTPUT
          echo "expiry=24 hours" >> $GITHUB_OUTPUT
        else
          echo "Upload failed!"
          echo "Could not extract a valid URL from the response."
          echo "upload_status=failed" >> $GITHUB_OUTPUT
          echo "error_message=Upload to bashupload.com failed or did not return a valid URL." >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Issue with Download Link
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const uploadStatus = '${{ steps.upload.outputs.upload_status }}';
          const downloadLink = '${{ steps.upload.outputs.download_link }}';
          const expiry = '${{ steps.upload.outputs.expiry }}';
          const errorMessage = '${{ steps.upload.outputs.error_message }}';

          const statusIcon = uploadStatus === 'success' ? '✅' : '❌';
          // Default to 'failed' if status is missing, preventing empty labels.
          const finalStatus = uploadStatus || 'failed'; 
          const issueTitle = `Upload Test ${statusIcon} ${finalStatus.charAt(0).toUpperCase() + finalStatus.slice(1)} - ${new Date().toLocaleDateString()}`;
          
          const labels = ['upload-test', finalStatus];
          
          let issueBody = `## File Upload Test Results\n\n`;
          
          if (uploadStatus === 'success') {
            issueBody += `**Status:** ${statusIcon} Upload Successful\n\n`;
            issueBody += `### Download Information\n`;
            issueBody += `**Download Link:** [${downloadLink}](${downloadLink})\n`;
            issueBody += `**Expires:** Approximately ${expiry}\n`;
          } else {
            issueBody += `**Status:** ${statusIcon} Upload Failed\n\n`;
            issueBody += `**Reason:** \`\`\`\n${errorMessage || 'An unknown error occurred during the upload step.'}\n\`\`\`\n\n`;
          }
          
          issueBody += `### Build Details\n`;
          issueBody += `- **Repository:** ${{ github.repository }}\n`;
          issueBody += `- **Commit:** ${{ github.sha }}\n`;
          issueBody += `- **Workflow Run:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          
          try {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: labels
            });
            console.log(`Issue created successfully: ${issue.data.html_url}`);
          } catch (error) {
            console.error('Failed to create issue:', error);
            throw error;
          }
